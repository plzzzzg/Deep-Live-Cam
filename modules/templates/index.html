<!DOCTYPE html>
<html>
<head>
    <title>实时人脸替换</title>
    <style>
        .container {
            display: flex;
            justify-content: space-between;
            padding: 20px;
        }
        .video-panel {
            width: 45%;
        }
        video, canvas {
            width: 100%;
            border: 1px solid #ccc;
        }
        .controls {
            text-align: center;
            margin: 20px 0;
        }
        .controls button {
            padding: 10px 20px;
            margin: 0 10px;
            font-size: 16px;
            cursor: pointer;
        }
        .controls input {
            width: 100px;
            padding: 5px;
            margin: 0 10px;
        }
        .server-control {
            margin-bottom: 15px;
        }
        .server-control input {
            width: 200px;
        }
        .stats {
            margin-top: 15px;
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 5px;
            display: flex;
            justify-content: center;
        }
        .stats-item {
            margin: 0 15px;
            font-size: 14px;
        }
        .stats-value {
            font-weight: bold;
            color: #4CAF50;
        }
    </style>
</head>
<body>
    <div class="controls">
        <div class="server-control">
            <label>
                服务器地址:
                <input type="text" id="serverAddress" value="192.168.59.20:16000">
            </label>
            <button id="connectBtn">连接</button>
        </div>
        <button id="startBtn" disabled>启动</button>
        <button id="stopBtn" disabled>停止</button>
        <label>
            帧率间隔(毫秒):
            <input type="number" id="frameInterval" value="150" min="16" max="1000" step="1">
        </label>
        <div class="stats">
            <div class="stats-item">延迟: <span id="latency" class="stats-value">0</span> ms</div>
            <div class="stats-item">帧率: <span id="fps" class="stats-value">0</span> fps</div>
        </div>
    </div>
    <div class="container">
        <div class="video-panel">
            <h3>原始视频</h3>
            <video id="sourceVideo" autoplay playsinline></video>
        </div>
        <div class="video-panel">
            <h3>处理后视频</h3>
            <canvas id="outputCanvas"></canvas>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
        let socket = null;
        const video = document.getElementById('sourceVideo');
        const canvas = document.getElementById('outputCanvas');
        const ctx = canvas.getContext('2d');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const frameIntervalInput = document.getElementById('frameInterval');
        const serverAddressInput = document.getElementById('serverAddress');
        const connectBtn = document.getElementById('connectBtn');
        const latencyDisplay = document.getElementById('latency');
        const fpsDisplay = document.getElementById('fps');
        
        let isRunning = false;
        let frameInterval = 400; // 使用输入框的默认值
        let frameTimer = null;
        let lastFrameSentTime = 0;
        let frameCount = 0;
        let lastFpsUpdateTime = 0;
        
        // 连接服务器
        connectBtn.addEventListener('click', () => {
            if (socket) {
                socket.disconnect();
            }
            
            const address = serverAddressInput.value;
            socket = io(`ws://${address}`);
            
            socket.on('connect', () => {
                console.log('已连接到服务器');
                startBtn.disabled = false;
                connectBtn.textContent = '重新连接';
            });
            
            socket.on('disconnect', () => {
                console.log('与服务器断开连接');
                startBtn.disabled = true;
                stopBtn.disabled = true;
                if (isRunning) {
                    stopCamera();
                }
            });
            
            socket.on('error', (error) => {
                console.error('服务器错误:', error);
                alert('服务器错误: ' + error);
            });
            
            // 接收处理后的帧
            socket.on('processed_frame', (data) => {
                // 计算延迟（从发送到接收的时间）
                const now = performance.now();
                const latency = now - lastFrameSentTime;
                latencyDisplay.textContent = Math.round(latency);
                
                // 计算帧率
                frameCount++;
                if (now - lastFpsUpdateTime >= 1000) { // 每秒更新一次帧率
                    fpsDisplay.textContent = frameCount;
                    frameCount = 0;
                    lastFpsUpdateTime = now;
                }
                
                const img = new Image();
                img.onload = () => {
                    ctx.drawImage(img, 0, 0);
                };
                img.src = data;
            });
        });
        
        // 启动/停止控制
        startBtn.addEventListener('click', () => {
            if (!isRunning) {
                initCamera();
                startBtn.disabled = true;
                stopBtn.disabled = false;
                isRunning = true;
                
                // 重置统计信息
                frameCount = 0;
                lastFpsUpdateTime = performance.now();
            }
        });
        
        stopBtn.addEventListener('click', () => {
            if (isRunning) {
                stopCamera();
                startBtn.disabled = false;
                stopBtn.disabled = true;
                isRunning = false;
                
                // 清空统计信息
                latencyDisplay.textContent = '0';
                fpsDisplay.textContent = '0';
            }
        });
        
        // 帧率间隔控制
        frameIntervalInput.addEventListener('change', () => {
            const value = parseInt(frameIntervalInput.value);
            if (value >= 16 && value <= 1000) {
                frameInterval = value;
                if (isRunning) {
                    stopFrameCapture();
                    startFrameCapture();
                }
            } else {
                alert('请输入16-1000之间的数值');
                frameIntervalInput.value = frameInterval;
            }
        });
        
        // 停止摄像头
        function stopCamera() {
            if (video.srcObject) {
                const tracks = video.srcObject.getTracks();
                tracks.forEach(track => track.stop());
                video.srcObject = null;
            }
            stopFrameCapture();
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
        
        // 开始帧捕获
        function startFrameCapture() {
            if (frameTimer) {
                clearInterval(frameTimer);
            }
            frameTimer = setInterval(sendFrame, frameInterval);
        }
        
        // 停止帧捕获
        function stopFrameCapture() {
            if (frameTimer) {
                clearInterval(frameTimer);
                frameTimer = null;
            }
        }
        
        // 获取摄像头权限
        async function initCamera() {
            // 检查浏览器是否支持 getUserMedia
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                // 兼容性处理
                const getUserMedia = navigator.getUserMedia ||
                    navigator.webkitGetUserMedia ||
                    navigator.mozGetUserMedia ||
                    navigator.msGetUserMedia;
                
                if (!getUserMedia) {
                    console.error('浏览器不支持 getUserMedia API');
                    alert('您的浏览器不支持摄像头访问，请使用最新版本的 Chrome、Firefox 或 Edge 浏览器。');
                    return;
                }

                navigator.mediaDevices = {};
                navigator.mediaDevices.getUserMedia = function(constraints) {
                    return new Promise((resolve, reject) => {
                        getUserMedia.call(navigator, constraints, resolve, reject);
                    });
                }
            }

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: {
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    } 
                });
                video.srcObject = stream;
                
                // 设置画布大小
                video.addEventListener('loadedmetadata', () => {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                });
                
                // 开始发送视频帧
                startFrameCapture();
            } catch (err) {
                console.error('无法访问摄像头:', err);
                alert('无法访问摄像头，请确保：\n1. 已授予浏览器摄像头访问权限\n2. 摄像头未被其他应用程序占用\n3. 使用 HTTPS 或 localhost 访问此页面');
            }
        }

        // 发送视频帧到服务器
        function sendFrame() {
            if (!socket || !socket.connected || !video.srcObject) {
                console.warn('未连接到服务器或视频未就绪，无法发送视频帧');
                return;
            }
            
            lastFrameSentTime = performance.now(); // 记录发送时间
            
            const tempCanvas = document.createElement('canvas');
            // 设置临时画布为480p分辨率
            const targetHeight = 480;
            const targetWidth = Math.floor(video.videoWidth * (targetHeight / video.videoHeight));
            
            tempCanvas.width = targetWidth;
            tempCanvas.height = targetHeight;
            
            // 绘制并缩放图像
            const ctx = tempCanvas.getContext('2d');
            // 使用双线性插值算法进行缩放，提高图像质量
            ctx.imageSmoothingEnabled = true;
            ctx.imageSmoothingQuality = 'high';
            ctx.drawImage(video, 0, 0, targetWidth, targetHeight);
            
            // 转换为JPEG格式并发送，适当降低质量以减小数据量
            const dataURL = tempCanvas.toDataURL('image/jpeg', 0.85);
            socket.emit('video_feed', dataURL);
        }
    </script>
</body>
</html>